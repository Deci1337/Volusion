<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2Inclusion - –ü–æ–º–æ—â—å –¥–ª—è –ª—é–¥–µ–π —Å –û–í–ó</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        html, body {
            width: 100%;
            height: 100%;
            font-family: Arial, sans-serif;
        }
        
        #map {
            width: 100%;
            height: 100%;
        }
        
        .control-panel {
            position: absolute;
            top: 20px;
            right: 50px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .btn {
            padding: 12px 20px;
            background: white;
            border: 2px solid #007bff;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            color: #333;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
        }
        
        .btn:hover {
            background: #007bff;
            color: white;
        }
        
        .location-btn {
            border-color: #28a745;
            background: #28a745;
            color: white;
        }
        
        .location-btn:hover {
            background: #218838;
            border-color: #218838;
        }
        
        .status {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(255,255,255,0.9);
            padding: 10px 15px;
            border-radius: 5px;
            font-size: 14px;
            z-index: 1000;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        .coordinates {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(255,255,255,0.9);
            padding: 10px 15px;
            border-radius: 5px;
            font-size: 12px;
            z-index: 1000;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .add-task-btn {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: white;
            border: 2px solid #28a745;
            border-radius: 50%;
            cursor: pointer;
            font-size: 24px;
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
        }

        .add-task-btn:hover {
            background: #28a745;
            color: white;
            transform: scale(1.1);
        }

        .address-input {
            position: absolute;
            bottom: 20px;
            right: 50px;
            background: rgba(255,255,255,0.95);
            padding: 15px;
            border-radius: 8px;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            min-width: 300px;
        }

        .address-input label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
        }

        .address-input input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∑–∞–¥–∞—á–∏ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .close {
            float: right;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            color: #666;
        }
        
        .close:hover {
            color: #000;
        }
        
        .modal-title {
            text-align: center;
            margin-bottom: 25px;
            color: #333;
            font-size: 22px;
            font-weight: bold;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: bold;
        }
        
        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: #007bff;
        }
        
        .form-textarea {
            height: 100px;
            resize: vertical;
        }
        
        .points-group {
            display: flex;
            gap: 15px;
            margin-top: 10px;
        }
        
        .point-input {
            flex: 1;
        }
        
        .btn-primary {
            width: 100%;
            padding: 15px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s;
            margin-top: 10px;
        }
        
        .btn-primary:hover {
            background: #0056b3;
        }
        
        .btn-primary:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .success-message {
            color: #28a745;
            font-size: 16px;
            margin-top: 15px;
            text-align: center;
            display: none;
        }

        .responses-count {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255,255,255,0.9);
            padding: 10px 15px;
            border-radius: 5px;
            font-size: 14px;
            z-index: 1000;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
    </style>
</head>
<body>
    <div id="map"></div>
    
    <div class="control-panel">
        <button class="btn location-btn" onclick="getUserLocation()">
            üéØ –ú–æ—ë –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ
        </button>
        <button class="btn" onclick="startTracking()" style="border-color: #ffc107;">
            üîÑ –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ
        </button>
        <button class="btn" onclick="stopTracking()" style="border-color: #dc3545;">
            ‚èπÔ∏è –ü—Ä–µ–∫—Ä–∞—Ç–∏—Ç—å –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å
        </button>
        <button class="btn" onclick="showMoscow()">
            üè¢ –ú–æ—Å–∫–≤–∞
        </button>
    </div>

    <div class="address-input">
        <label for="userAddress">–í–≤–µ–¥–∏—Ç–µ —Å–≤–æ–π –∞–¥—Ä–µ—Å:</label>
        <input type="text" id="userAddress" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ú–æ—Å–∫–≤–∞, —É–ª. –¢–≤–µ—Ä—Å–∫–∞—è, 1">
    </div>

    <button class="add-task-btn" onclick="showAddTaskModal()">
        +
    </button>
    
    <div class="coordinates" id="coordinates">
        –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã
    </div>
    
    <div class="status" id="status">
        –ö–∞—Ä—Ç–∞ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è...
    </div>

    <div class="responses-count" id="responsesCount">
        –û—Ç–∫–ª–∏–∫–æ–≤: 0
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∑–∞–¥–∞—á–∏ -->
    <div id="addTaskModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeAddTaskModal()">&times;</span>
            <div class="modal-title">–î–æ–±–∞–≤—å—Ç–µ –≤–∞—à—É –∑–∞–¥–∞—á—É</div>
            
            <form id="taskForm">
                <div class="form-group">
                    <label class="form-label">1) –£–∫–∞–∂–∏—Ç–µ –≤–∞—à –≤–æ–∑—Ä–∞—Å—Ç</label>
                    <input type="number" class="form-input" id="userAge" min="1" max="120" required>
                </div>

                <div class="form-group">
                    <label class="form-label">2) –£–∫–∞–∂–∏—Ç–µ —Ç–∏–ø –∏–Ω–≤–∞–ª–∏–¥–Ω–æ—Å—Ç–∏</label>
                    <select class="form-select" id="disabilityType" required>
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –∏–Ω–≤–∞–ª–∏–¥–Ω–æ—Å—Ç–∏</option>
                        <option value="–û–ø–æ—Ä–Ω–æ-–¥–≤–∏–≥–∞—Ç–µ–ª—å–Ω—ã–π –∞–ø–ø–∞—Ä–∞—Ç">–û–ø–æ—Ä–Ω–æ-–¥–≤–∏–≥–∞—Ç–µ–ª—å–Ω—ã–π –∞–ø–ø–∞—Ä–∞—Ç</option>
                        <option value="–ù–∞—Ä—É—à–µ–Ω–∏–µ –∑—Ä–µ–Ω–∏—è">–ù–∞—Ä—É—à–µ–Ω–∏–µ –∑—Ä–µ–Ω–∏—è</option>
                        <option value="–ù–∞—Ä—É—à–µ–Ω–∏–µ —Å–ª—É—Ö–∞">–ù–∞—Ä—É—à–µ–Ω–∏–µ —Å–ª—É—Ö–∞</option>
                        <option value="–ú–µ–Ω—Ç–∞–ª—å–Ω—ã–µ –Ω–∞—Ä—É—à–µ–Ω–∏—è">–ú–µ–Ω—Ç–∞–ª—å–Ω—ã–µ –Ω–∞—Ä—É—à–µ–Ω–∏—è</option>
                        <option value="–û–±—â–µ–µ –∑–∞–±–æ–ª–µ–≤–∞–Ω–∏–µ">–û–±—â–µ–µ –∑–∞–±–æ–ª–µ–≤–∞–Ω–∏–µ</option>
                        <option value="–î—Ä—É–≥–æ–µ">–î—Ä—É–≥–æ–µ</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">3) –û–ø–∏—à–∏—Ç–µ, —á–µ–º –≤–∞–º –Ω—É–∂–Ω–æ –ø–æ–º–æ—á—å</label>
                    <textarea class="form-textarea" id="helpDescription" placeholder="–ü–æ–¥—Ä–æ–±–Ω–æ –æ–ø–∏—à–∏—Ç–µ, –∫–∞–∫–∞—è –ø–æ–º–æ—â—å –≤–∞–º —Ç—Ä–µ–±—É–µ—Ç—Å—è..." required></textarea>
                </div>

                <div class="form-group">
                    <label class="form-label">4) –ö–æ–≥–¥–∞ –≤–∞–º –Ω—É–∂–Ω–æ –ø–æ–º–æ—á—å (–¥–∞—Ç–∞ –∏ –≤—Ä–µ–º—è)</label>
                    <input type="datetime-local" class="form-input" id="helpDateTime" required>
                </div>

                <div class="form-group">
                    <label class="form-label">5) –ú–∞—Ä—à—Ä—É—Ç –ø–æ–º–æ—â–∏</label>
                    <div class="points-group">
                        <div class="point-input">
                            <label class="form-label">–¢–æ—á–∫–∞ –ê (–æ—Ç–∫—É–¥–∞)</label>
                            <input type="text" class="form-input" id="pointA" placeholder="–ù–∞—á–∞–ª—å–Ω–∞—è —Ç–æ—á–∫–∞" required>
                        </div>
                        <div class="point-input">
                            <label class="form-label">–¢–æ—á–∫–∞ –ë (–∫—É–¥–∞)</label>
                            <input type="text" class="form-input" id="pointB" placeholder="–ö–æ–Ω–µ—á–Ω–∞—è —Ç–æ—á–∫–∞" required>
                        </div>
                    </div>
                </div>

                <button type="submit" class="btn-primary" id="submitTaskBtn">–î–∞–ª–µ–µ</button>
            </form>

            <div class="success-message" id="successMessage">
                –ó–∞–¥–∞—á–∞ —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∞! –û—Ç–∫–ª–∏–∫–æ–≤: 0
            </div>
        </div>
    </div>

    <script src="https://mapgl.2gis.com/api/js/v1"></script>
    <script>
        let map;
        let userMarker;
        let watchId = null;
        let routeLine = null;
        let startMarker = null;
        let endMarker = null;

        // –£–±—Ä–∞–Ω—ã –º–∞—Ä–∫–µ—Ä—ã –ø–æ–º–æ—â–∏, —Ç–∞–∫ –∫–∞–∫ —Ç–µ–ø–µ—Ä—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–∞–º —Å–æ–∑–¥–∞–µ—Ç –∑–∞–¥–∞—á–∏

        function initMap() {
            map = new mapgl.Map('map', {
                center: [37.6175, 55.7558],
                zoom: 13,
                key: '783e0858-39de-4c83-a72c-bc2858c795be',
            });

            updateStatus('–ö–∞—Ä—Ç–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞. –ù–∞–∂–º–∏—Ç–µ "+" —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É');
        }

        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
        function showAddTaskModal() {
            document.getElementById('addTaskModal').style.display = 'flex';
            document.getElementById('successMessage').style.display = 'none';
            document.getElementById('taskForm').reset();
        }

        function closeAddTaskModal() {
            document.getElementById('addTaskModal').style.display = 'none';
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ä–º—ã –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∑–∞–¥–∞—á–∏
        document.getElementById('taskForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const taskData = {
                age: document.getElementById('userAge').value,
                disabilityType: document.getElementById('disabilityType').value,
                helpDescription: document.getElementById('helpDescription').value,
                helpDateTime: document.getElementById('helpDateTime').value,
                pointA: document.getElementById('pointA').value,
                pointB: document.getElementById('pointB').value,
                timestamp: new Date().toISOString(),
                responses: 0
            };
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∑–∞–¥–∞—á—É –≤ localStorage
            saveTask(taskData);
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ
            document.getElementById('successMessage').style.display = 'block';
            document.getElementById('taskForm').reset();
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ –æ—Ç–∫–ª–∏–∫–æ–≤
            updateResponsesCount();
            
            console.log('–ó–∞–¥–∞—á–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞:', taskData);
            
            // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã
            setTimeout(() => {
                closeAddTaskModal();
            }, 2000);
        });

        function saveTask(taskData) {
            let tasks = JSON.parse(localStorage.getItem('userTasks') || '[]');
            tasks.push(taskData);
            localStorage.setItem('userTasks', JSON.stringify(tasks));
        }

        function updateResponsesCount() {
            document.getElementById('responsesCount').textContent = '–û—Ç–∫–ª–∏–∫–æ–≤: 0';
        }

        // –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ –∫–∞—Ä—Ç—ã (–æ—Å—Ç–∞–≤–ª–µ–Ω—ã –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
        function showMoscow() {
            if (map) {
                map.setCenter([37.6175, 55.7558]);
                map.setZoom(13);
                updateStatus('–ú–æ—Å–∫–≤–∞');
            }
        }

        function getUserLocation() {
            if (!navigator.geolocation) {
                alert('–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤–∞—à–∏–º –±—Ä–∞—É–∑–µ—Ä–æ–º');
                return;
            }

            updateStatus('–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è...');

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const coords = [position.coords.longitude, position.coords.latitude];
                    showUserLocation(coords, position.coords.accuracy);
                    updateStatus('–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ!');
                },
                (error) => {
                    handleLocationError(error);
                }
            );
        }

        function startTracking() {
            if (!navigator.geolocation) {
                alert('–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤–∞—à–∏–º –±—Ä–∞—É–∑–µ—Ä–æ–º');
                return;
            }

            if (watchId) {
                alert('–û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —É–∂–µ –∞–∫—Ç–∏–≤–Ω–æ');
                return;
            }

            updateStatus('–ù–∞—á–∞—Ç–æ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è...');
            watchId = navigator.geolocation.watchPosition(
                (position) => {
                    const coords = [position.coords.longitude, position.coords.latitude];
                    showUserLocation(coords, position.coords.accuracy);
                    updateStatus('–û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ');
                },
                (error) => {
                    handleLocationError(error);
                    stopTracking();
                }
            );
        }

        function showUserLocation(coords, accuracy) {
            if (!map) return;

            if (userMarker) {
                userMarker.destroy();
            }

            userMarker = new mapgl.Marker(map, {
                coordinates: coords,
                icon: 'https://docs.2gis.com/img/mapgl/marker.svg',
                color: '#28a745',
                size: [35, 35]
            });

            map.setCenter(coords);
            map.setZoom(16);
            updateCoordinates(coords, accuracy);
        }

        function updateCoordinates(coords, accuracy) {
            const coordsElement = document.getElementById('coordinates');
            if (coordsElement) {
                coordsElement.innerHTML = `
                    –®–∏—Ä–æ—Ç–∞: ${coords[1].toFixed(6)}<br>
                    –î–æ–ª–≥–æ—Ç–∞: ${coords[0].toFixed(6)}<br>
                    –¢–æ—á–Ω–æ—Å—Ç—å: ${accuracy ? accuracy.toFixed(0) + ' –º' : '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}
                `;
            }
        }

        function handleLocationError(error) {
            let message = '';
            
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    message = '–î–æ—Å—Ç—É–ø –∫ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏ –∑–∞–ø—Ä–µ—â–µ–Ω';
                    break;
                case error.POSITION_UNAVAILABLE:
                    message = '–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞';
                    break;
                case error.TIMEOUT:
                    message = '–í—Ä–µ–º—è –∑–∞–ø—Ä–æ—Å–∞ –∏—Å—Ç–µ–∫–ª–æ';
                    break;
                default:
                    message = '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞';
                    break;
            }
            
            updateStatus('–û—à–∏–±–∫–∞: ' + message);
        }

        function updateStatus(text) {
            const statusElement = document.getElementById('status');
            if (statusElement) {
                statusElement.textContent = text;
            }
        }

        function stopTracking() {
            if (watchId) {
                navigator.geolocation.clearWatch(watchId);
                watchId = null;
                updateStatus('–û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ');
            }
        }

        function clearRoute() {
            if (routeLine) {
                routeLine.destroy();
                routeLine = null;
            }
            if (startMarker) {
                startMarker.destroy();
                startMarker = null;
            }
            if (endMarker) {
                endMarker.destroy();
                endMarker = null;
            }
            
            updateStatus('–ú–∞—Ä—à—Ä—É—Ç –æ—á–∏—â–µ–Ω');
        }

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
        window.addEventListener('click', function(event) {
            const modal = document.getElementById('addTaskModal');
            if (event.target === modal) {
                closeAddTaskModal();
            }
        });

        window.addEventListener('load', initMap);
        window.addEventListener('beforeunload', () => {
            stopTracking();
        });
    </script>
</body>
</html>