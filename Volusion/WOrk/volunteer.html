<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2Inclusion</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        html, body {
            width: 100%;
            height: 100%;
            font-family: Arial, sans-serif;
            font-size: 16px;
        }
        
        #map {
            width: 100%;
            height: 100%;
        }
        
        .control-panel {
            position: absolute;
            top: 100px;
            right: 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 12px;
            background: rgba(255,255,255,0.95);
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            min-width: 280px;
        }
        
        .btn {
            padding: 15px 20px;
            background: white;
            border: 2px solid #007bff;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            color: #333;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            transition: all 0.3s ease;
            text-align: center;
        }
        
        .btn:hover {
            background: #007bff;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        
        .location-btn {
            border-color: #28a745;
            background: #28a745;
            color: white;
        }
        
        .location-btn:hover {
            background: #218838;
            border-color: #218838;
        }
        
        .status {
            position: absolute;
            bottom: 90px;
            left: 20px;
            background: rgba(255,255,255,0.95);
            padding: 15px 20px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            z-index: 1000;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            max-width: 300px;
        }
        
        .coordinates {
            position: absolute;
            top: 100px;
            left: 20px;
            background: rgba(255,255,255,0.95);
            padding: 15px 20px;
            border-radius: 10px;
            font-size: 14px;
            z-index: 1000;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            max-width: 250px;
        }

        .volunteer-title {
            position: absolute;
            top: 20px;
            left: 20px;
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            padding: 20px 30px;
            border-radius: 12px;
            font-size: 28px;
            font-weight: bold;
            z-index: 1000;
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
            text-align: center;
            line-height: 1.2;
        }

        .task-list-btn {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: white;
            border: 2px solid #6c757d;
            border-radius: 10px;
            cursor: pointer;
            font-size: 24px;
            padding: 15px 20px;
            z-index: 1000;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
        }

        .task-list-btn:hover {
            background: #6c757d;
            color: white;
            transform: translateY(-2px);
        }

        .address-input {
            position: absolute;
            bottom: 90px;
            right: 20px;
            background: rgba(255,255,255,0.95);
            padding: 20px;
            border-radius: 12px;
            z-index: 1000;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            min-width: 320px;
        }

        .address-input label {
            display: block;
            margin-bottom: 12px;
            font-weight: bold;
            color: #333;
            font-size: 16px;
        }

        .address-input input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
        }

        .address-input input:focus {
            border-color: #007bff;
            outline: none;
        }

        .marker-popup {
            position: absolute;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            z-index: 1001;
            max-width: 500px;
            min-width: 450px;
            display: none;
            border: 3px solid #007bff;
        }

        .marker-popup h3 {
            margin-bottom: 20px;
            color: #333;
            border-bottom: 2px solid #eee;
            padding-bottom: 15px;
            font-size: 24px;
            line-height: 1.3;
        }

        .marker-popup p {
            margin: 12px 0;
            font-size: 18px;
            color: #555;
            line-height: 1.5;
        }

        .marker-popup .respond-btn {
            width: 100%;
            padding: 18px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
            margin-top: 20px;
            transition: all 0.3s ease;
        }

        .marker-popup .respond-btn:hover {
            background: #0056b3;
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0,0,0,0.2);
        }

        .route-choice-popup {
            position: absolute;
            background: white;
            border-radius: 15px;
            padding: 35px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            z-index: 1002;
            max-width: 450px;
            min-width: 400px;
            display: none;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            border: 3px solid #28a745;
        }

        .route-choice-popup h3 {
            margin-bottom: 25px;
            color: #333;
            text-align: center;
            font-size: 24px;
        }

        .route-choice-btn {
            width: 100%;
            padding: 18px;
            margin: 12px 0;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .route-choice-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0,0,0,0.2);
        }

        .route-choice-btn.location {
            background: #28a745;
        }

        .route-choice-btn.location:hover {
            background: #218838;
        }

        .route-choice-btn.address {
            background: #ffc107;
            color: #333;
        }

        .route-choice-btn.address:hover {
            background: #e0a800;
        }

        .close-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #999;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .close-btn:hover {
            background: #f8f9fa;
            color: #333;
        }

        .disability-badge {
            display: inline-block;
            padding: 6px 15px;
            background: #ff6b6b;
            color: white;
            border-radius: 20px;
            font-size: 16px;
            font-weight: bold;
            margin-left: 12px;
        }

        .urgent-badge {
            display: inline-block;
            padding: 6px 15px;
            background: #dc3545;
            color: white;
            border-radius: 20px;
            font-size: 16px;
            font-weight: bold;
            margin-left: 12px;
            animation: pulse 2s infinite;
        }

        .route-info {
            position: absolute;
            top: 200px;
            left: 20px;
            background: rgba(255,255,255,0.95);
            padding: 15px 20px;
            border-radius: 10px;
            font-size: 16px;
            z-index: 1000;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            max-width: 300px;
            display: none;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        /* Адаптивность для мобильных устройств */
        @media (max-width: 768px) {
            .control-panel {
                top: 120px;
                right: 10px;
                left: 10px;
                min-width: auto;
            }
            
            .volunteer-title {
                top: 10px;
                left: 10px;
                right: 10px;
                font-size: 22px;
                padding: 15px 20px;
            }
            
            .coordinates {
                top: 80px;
                left: 10px;
                right: 10px;
                max-width: none;
            }
            
            .address-input {
                bottom: 80px;
                left: 10px;
                right: 10px;
                min-width: auto;
            }
            
            .status {
                bottom: 150px;
                left: 10px;
                right: 10px;
                max-width: none;
            }
        }
    </style>
</head>
<body>
    <div id="map"></div>
    
    <div class="volunteer-title">
        Я - Волонтёр!
    </div>
    
    <div class="control-panel">
        <button class="btn location-btn" onclick="getUserLocation()">
            🎯 Моё местоположение
        </button>
        <button class="btn" onclick="startTracking()" style="border-color: #ffc107;">
            🔄 Определить местоположение
        </button>
        <button class="btn" onclick="stopTracking()" style="border-color: #dc3545;">
            ⏹️ Прекратить отслеживать
        </button>
        <button class="btn" onclick="showMoscow()">
            🏢 Москва
        </button>
        <button class="btn" onclick="clearRoute()" style="border-color: #6c757d;">
            🗑️ Очистить маршрут
        </button>
    </div>

    <div class="address-input">
        <label for="userAddress">Введите свой адрес:</label>
        <input type="text" id="userAddress" placeholder="Например: Москва, ул. Тверская, 1">
    </div>

    <button class="task-list-btn" onclick="toggleTaskList()">
        ☰ Задачи
    </button>
    
    <div class="coordinates" id="coordinates">
        Координаты: не определены
    </div>
    
    <div class="status" id="status">
        Карта загружается...
    </div>

    <div class="route-info" id="routeInfo">
        <strong>Информация о маршруте:</strong>
        <div id="routeDetails">Маршрут не построен</div>
    </div>

    <div class="marker-popup" id="markerPopup">
        <button class="close-btn" onclick="closePopup()">×</button>
        <h3 id="popupName"></h3>
        <p><strong>Возраст:</strong> <span id="popupAge"></span></p>
        <p><strong>Тип инвалидности:</strong> <span id="popupDisability"></span></p>
        <p><strong>Описание помощи:</strong> <span id="popupDescription"></span></p>
        <p><strong>Дата и время:</strong> <span id="popupDateTime"></span></p>
        <button class="respond-btn" onclick="showRouteChoice()">🗺️ Откликнуться на помощь</button>
    </div>

    <div class="route-choice-popup" id="routeChoicePopup">
        <button class="close-btn" onclick="closeRouteChoicePopup()">×</button>
        <h3>Выберите начало маршрута</h3>
        <button class="route-choice-btn location" onclick="buildRouteFromLocation()">
            📍 От моего местоположения
        </button>
        <button class="route-choice-btn address" onclick="buildRouteFromAddress()">
            🏠 От введенного адреса
        </button>
    </div>

    <script src="https://mapgl.2gis.com/api/js/v1"></script>
    <script>
        let map;
        let userMarker;
        let watchId = null;
        let routeLine = null;
        let startMarker = null;
        let endMarker = null;
        let helpMarkers = [];
        let currentMarkerData = null;

        const helpRequests = [
            {
                id: 1,
                coordinates: [37.6175, 55.7558],
                name: "Иванова Мария Петровна",
                age: 72,
                disability: "Опорно-двигательный аппарат",
                description: "Нужна помощь с покупкой продуктов и лекарств в ближайшей аптеке и магазине",
                datetime: "07.10.2025, 14:00",
                urgent: false
            },
            {
                id: 2,
                coordinates: [37.6100, 55.7520],
                name: "Петров Алексей Сергеевич",
                age: 68,
                disability: "Нарушение зрения",
                description: "Требуется сопровождение в поликлинику №5 для планового осмотра",
                datetime: "08.10.2025, 10:30",
                urgent: true
            },
            {
                id: 3,
                coordinates: [37.6250, 55.7580],
                name: "Сидорова Анна Ивановна",
                age: 75,
                disability: "Опорно-двигательный аппарат",
                description: "Помощь в уборке квартиры (влажная уборка, вынос мусора)",
                datetime: "09.10.2025, 12:00",
                urgent: false
            },
            {
                id: 4,
                coordinates: [37.6000, 55.7500],
                name: "Козлов Владимир Николаевич",
                age: 80,
                disability: "Нарушение слуха",
                description: "Помощь с оформлением документов в социальной службе",
                datetime: "10.10.2025, 11:00",
                urgent: false
            },
            {
                id: 5,
                coordinates: [37.6300, 55.7600],
                name: "Николаева Ольга Васильевна",
                age: 78,
                disability: "Общее заболевание",
                description: "Нужна помощь по дому: приготовление еды, уборка",
                datetime: "11.10.2025, 15:00",
                urgent: false
            },
            {
                id: 6,
                coordinates: [37.6150, 55.7450],
                name: "Фёдоров Сергей Иванович",
                age: 65,
                disability: "Нарушение зрения",
                description: "Сопровождение в банк для оплаты коммунальных услуг",
                datetime: "12.10.2025, 13:30",
                urgent: true
            },
            {
                id: 7,
                coordinates: [37.6050, 55.7650],
                name: "Морозова Елена Викторовна",
                age: 82,
                disability: "Опорно-двигательный аппарат",
                description: "Помощь с доставкой тяжелых продуктов из супермаркета",
                datetime: "13.10.2025, 16:00",
                urgent: false
            },
            {
                id: 8,
                coordinates: [37.6350, 55.7500],
                name: "Громов Павел Александрович",
                age: 70,
                disability: "Общее заболевание",
                description: "Нужна помощь в заполнении анкет для получения льгот",
                datetime: "14.10.2025, 09:00",
                urgent: false
            },
            {
                id: 9,
                coordinates: [37.6200, 55.7400],
                name: "Волкова Ирина Сергеевна",
                age: 74,
                disability: "Нарушение слуха",
                description: "Сопровождение на почту для отправки посылки родственникам",
                datetime: "15.10.2025, 14:30",
                urgent: false
            },
            {
                id: 10,
                coordinates: [37.6400, 55.7550],
                name: "Тихонов Михаил Петрович",
                age: 79,
                disability: "Опорно-двигательный аппарат",
                description: "Помощь в прогулке на свежем воздухе в парке",
                datetime: "16.10.2025, 11:00",
                urgent: false
            }
        ];

        function initMap() {
            map = new mapgl.Map('map', {
                center: [37.6175, 55.7558],
                zoom: 13,
                key: '783e0858-39de-4c83-a72c-bc2858c795be',
            });

            map.on('click', function(event) {
                const coords = event.lngLat;
                updateCoordinates([coords.lng, coords.lat], null);
            });

            setTimeout(() => {
                addHelpMarkers();
            }, 1000);
        }

        function addHelpMarkers() {
            helpRequests.forEach(request => {
                const markerColor = request.urgent ? '#dc3545' : '#007bff';
                
                const marker = new mapgl.Marker(map, {
                    coordinates: request.coordinates,
                    icon: 'https://docs.2gis.com/img/mapgl/marker.svg',
                    color: markerColor,
                    size: [50, 50],
                });

                marker.on('click', () => {
                    showMarkerPopup(request);
                });

                helpMarkers.push(marker);
            });
            
            updateStatus(`Доступно: ${helpMarkers.length} маркеров помощи. Нажмите на любой маркер`);
        }

        function showMarkerPopup(data) {
            currentMarkerData = data;
            
            document.getElementById('popupName').innerHTML = data.name + 
                (data.urgent ? '<span class="urgent-badge">СРОЧНО</span>' : '');
            document.getElementById('popupAge').textContent = data.age + ' лет';
            document.getElementById('popupDisability').textContent = data.disability;
            document.getElementById('popupDescription').textContent = data.description;
            document.getElementById('popupDateTime').textContent = data.datetime;
            
            const popup = document.getElementById('markerPopup');
            popup.style.display = 'block';
            popup.style.left = '50%';
            popup.style.top = '50%';
            popup.style.transform = 'translate(-50%, -50%)';
        }

        function closePopup() {
            document.getElementById('markerPopup').style.display = 'none';
            currentMarkerData = null;
        }

        function showRouteChoice() {
            closePopup();
            document.getElementById('routeChoicePopup').style.display = 'block';
        }

        function closeRouteChoicePopup() {
            document.getElementById('routeChoicePopup').style.display = 'none';
        }

        function buildRouteFromLocation() {
            closeRouteChoicePopup();
            
            if (!currentMarkerData) return;
            
            clearRoute();
            
            if (userMarker) {
                const userCoords = userMarker.getCoordinates();
                buildRouteFromCurrentLocation(userCoords, currentMarkerData.coordinates);
            } else {
                getUserLocationForRoute(currentMarkerData.coordinates);
            }
        }

        async function buildRouteFromAddress() {
            closeRouteChoicePopup();
            
            if (!currentMarkerData) return;
            
            const userAddress = document.getElementById('userAddress').value;
            if (!userAddress) {
                alert('Пожалуйста, введите ваш адрес');
                return;
            }

            updateStatus('Определение координат адреса...');

            try {
                const startCoords = await geocodeAddress(userAddress);
                buildRouteFromCurrentLocation([startCoords.lon, startCoords.lat], currentMarkerData.coordinates);
            } catch (error) {
                updateStatus('Ошибка определения адреса');
                alert('Не удалось определить координаты введенного адреса');
            }
        }

        async function geocodeAddress(address) {
            try {
                const response = await fetch(`https://catalog.api.2gis.com/3.0/items/geocode?q=${encodeURIComponent(address)}&fields=items.point&key=40074715-85b5-400f-a2a8-a41b550be1e8`);
                
                if (!response.ok) {
                    throw new Error(`Ошибка геокодинга: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.result && data.result.items && data.result.items.length > 0) {
                    const point = data.result.items[0].point;
                    return {
                        lon: point.lon,
                        lat: point.lat
                    };
                } else {
                    throw new Error('Адрес не найден');
                }
            } catch (error) {
                console.error('Ошибка геокодинга:', error);
                throw error;
            }
        }

        function getUserLocationForRoute(destinationCoords) {
            if (!navigator.geolocation) {
                alert('Геолокация не поддерживается вашим браузером');
                return;
            }

            updateStatus('Определение местоположения для маршрута...');

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const userCoords = [position.coords.longitude, position.coords.latitude];
                    showUserLocation(userCoords, position.coords.accuracy);
                    buildRouteFromCurrentLocation(userCoords, destinationCoords);
                },
                (error) => {
                    handleLocationError(error);
                    alert('Не удалось определить ваше местоположение для построения маршрута');
                }
            );
        }

        async function buildRouteFromCurrentLocation(startCoords, endCoords) {
            updateStatus('Построение маршрута...');

            try {
                // Очищаем предыдущие маркеры и маршрут
                if (startMarker) startMarker.destroy();
                if (endMarker) endMarker.destroy();

                // Создаем маркеры начала и конца
                startMarker = new mapgl.Marker(map, {
                    coordinates: startCoords,
                    icon: 'https://docs.2gis.com/img/mapgl/marker.svg',
                    color: '#28a745',
                    size: [45, 45]
                });

                endMarker = new mapgl.Marker(map, {
                    coordinates: endCoords,
                    icon: 'https://docs.2gis.com/img/mapgl/marker.svg',
                    color: '#dc3545',
                    size: [45, 45]
                });

                // Используем Directions API для построения маршрута
                const response = await fetch(`https://routing.api.2gis.com/getRoute?key=f9fec7ee-27e4-4dd2-bccd-61b3ee664093&points=${startCoords[1]},${startCoords[0]};${endCoords[1]},${endCoords[0]}&type=pedestrian`);

                if (!response.ok) {
                    throw new Error('Ошибка построения маршрута');
                }

                const data = await response.json();
                
                if (data.result && data.result.path) {
                    displayRoute(data.result.path);
                } else {
                    // Если API не сработало, строим прямую линию
                    displaySimpleRoute(startCoords, endCoords);
                }

            } catch (error) {
                console.error('Ошибка построения маршрута:', error);
                // Строим простой маршрут как запасной вариант
                displaySimpleRoute(startCoords, endCoords);
            }
        }

        function displayRoute(routePath) {
            if (routeLine) {
                routeLine.destroy();
            }

            // Преобразуем координаты маршрута в нужный формат
            const coordinates = routePath.map(point => [point[1], point[0]]);

            routeLine = new mapgl.Polyline(map, {
                coordinates: coordinates,
                width: 6,
                color: "#007bff",
                opacity: 0.8
            });

            // Рассчитываем расстояние маршрута
            const distance = calculateRouteDistance(coordinates);
            const routeInfo = document.getElementById('routeInfo');
            const routeDetails = document.getElementById('routeDetails');
            
            routeDetails.innerHTML = `
                Расстояние: ${distance} км<br>
                Примерное время: ${Math.round(distance * 15)} мин
            `;
            routeInfo.style.display = 'block';

            updateStatus('Маршрут построен успешно!');
        }

        function displaySimpleRoute(startCoords, endCoords) {
            if (routeLine) {
                routeLine.destroy();
            }

            // Создаем простую прямую линию между точками
            routeLine = new mapgl.Polyline(map, {
                coordinates: [startCoords, endCoords],
                width: 6,
                color: "#007bff",
                opacity: 0.8
            });

            const distance = calculateSimpleDistance(startCoords, endCoords);
            const routeInfo = document.getElementById('routeInfo');
            const routeDetails = document.getElementById('routeDetails');
            
            routeDetails.innerHTML = `
                Расстояние: ${distance} км<br>
                Примерное время: ${Math.round(distance * 15)} мин<br>
                <small>(прямой маршрут)</small>
            `;
            routeInfo.style.display = 'block';

            updateStatus('Маршрут построен (прямая линия)');
        }

        function calculateRouteDistance(coordinates) {
            let totalDistance = 0;
            for (let i = 1; i < coordinates.length; i++) {
                totalDistance += calculateSimpleDistance(coordinates[i-1], coordinates[i]);
            }
            return (totalDistance).toFixed(1);
        }

        function calculateSimpleDistance(coord1, coord2) {
            const R = 6371; // Радиус Земли в км
            const dLat = (coord2[1] - coord1[1]) * Math.PI / 180;
            const dLon = (coord2[0] - coord1[0]) * Math.PI / 180;
            const a = 
                Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(coord1[1] * Math.PI / 180) * Math.cos(coord2[1] * Math.PI / 180) * 
                Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return (R * c).toFixed(1);
        }

        function showMoscow() {
            if (map) {
                map.setCenter([37.6175, 55.7558]);
                map.setZoom(13);
                updateStatus('Карта центрирована на Москве');
            }
        }

        function getUserLocation() {
            if (!navigator.geolocation) {
                alert('Геолокация не поддерживается вашим браузером');
                return;
            }

            updateStatus('Определение местоположения...');

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const coords = [position.coords.longitude, position.coords.latitude];
                    showUserLocation(coords, position.coords.accuracy);
                    updateStatus('Местоположение определено!');
                },
                (error) => {
                    handleLocationError(error);
                }
            );
        }

        function startTracking() {
            if (!navigator.geolocation) {
                alert('Геолокация не поддерживается вашим браузером');
                return;
            }

            if (watchId) {
                alert('Отслеживание уже активно');
                return;
            }

            updateStatus('Начато отслеживание местоположения...');

            watchId = navigator.geolocation.watchPosition(
                (position) => {
                    const coords = [position.coords.longitude, position.coords.latitude];
                    showUserLocation(coords, position.coords.accuracy);
                    updateStatus('Отслеживание активно');
                },
                (error) => {
                    handleLocationError(error);
                    stopTracking();
                }
            );
        }

        function showUserLocation(coords, accuracy) {
            if (!map) return;

            if (userMarker) {
                userMarker.destroy();
            }

            userMarker = new mapgl.Marker(map, {
                coordinates: coords,
                icon: 'https://docs.2gis.com/img/mapgl/marker.svg',
                color: '#28a745',
                size: [45, 45]
            });

            map.setCenter(coords);
            map.setZoom(16);
            updateCoordinates(coords, accuracy);
        }

        function updateCoordinates(coords, accuracy) {
            const coordsElement = document.getElementById('coordinates');
            if (coordsElement) {
                coordsElement.innerHTML = `
                    <strong>Координаты:</strong><br>
                    Широта: ${coords[1].toFixed(6)}<br>
                    Долгота: ${coords[0].toFixed(6)}<br>
                    Точность: ${accuracy ? accuracy.toFixed(0) + ' м' : 'неизвестно'}
                `;
            }
        }

        function handleLocationError(error) {
            let message = '';
            
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    message = 'Доступ к геолокации запрещен';
                    break;
                case error.POSITION_UNAVAILABLE:
                    message = 'Информация о местоположении недоступна';
                    break;
                case error.TIMEOUT:
                    message = 'Время запроса истекло';
                    break;
                default:
                    message = 'Произошла неизвестная ошибка';
                    break;
            }
            
            updateStatus('Ошибка: ' + message);
        }

        function updateStatus(text) {
            const statusElement = document.getElementById('status');
            if (statusElement) {
                statusElement.textContent = text;
            }
        }

        function stopTracking() {
            if (watchId) {
                navigator.geolocation.clearWatch(watchId);
                watchId = null;
                updateStatus('Отслеживание остановлено');
            }
        }

        function clearRoute() {
            if (routeLine) {
                routeLine.destroy();
                routeLine = null;
            }
            if (startMarker) {
                startMarker.destroy();
                startMarker = null;
            }
            if (endMarker) {
                endMarker.destroy();
                endMarker = null;
            }
            
            document.getElementById('routeInfo').style.display = 'none';
            updateStatus('Маршрут очищен');
        }

        function toggleTaskList() {
            alert('Функция списка задач будет реализована в будущем');
        }

        window.addEventListener('load', initMap);

        window.addEventListener('beforeunload', () => {
            stopTracking();
        });
    </script>
</body>
</html>