<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2Inclusion</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        html, body {
            width: 100%;
            height: 100%;
            font-family: Arial, sans-serif;
            font-size: 16px;
        }
        
        #map {
            width: 100%;
            height: 100%;
        }
        
        .control-panel {
            position: absolute;
            top: 100px;
            right: 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 12px;
            background: rgba(255,255,255,0.95);
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            min-width: 280px;
        }
        
        .btn {
            padding: 15px 20px;
            background: white;
            border: 2px solid #007bff;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            color: #333;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            transition: all 0.3s ease;
            text-align: center;
        }
        
        .btn:hover {
            background: #007bff;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        
        .location-btn {
            border-color: #28a745;
            background: #28a745;
            color: white;
        }
        
        .location-btn:hover {
            background: #218838;
            border-color: #218838;
        }
        
        .status {
            position: absolute;
            bottom: 90px;
            left: 20px;
            background: rgba(255,255,255,0.95);
            padding: 15px 20px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            z-index: 1000;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            max-width: 300px;
        }
        
        .coordinates {
            position: absolute;
            top: 100px;
            left: 20px;
            background: rgba(255,255,255,0.95);
            padding: 15px 20px;
            border-radius: 10px;
            font-size: 14px;
            z-index: 1000;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            max-width: 250px;
        }

        .volunteer-title {
            position: absolute;
            top: 20px;
            left: 20px;
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            padding: 20px 30px;
            border-radius: 12px;
            font-size: 28px;
            font-weight: bold;
            z-index: 1000;
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
            text-align: center;
            line-height: 1.2;
        }

        .task-list-btn {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: white;
            border: 2px solid #6c757d;
            border-radius: 10px;
            cursor: pointer;
            font-size: 24px;
            padding: 15px 20px;
            z-index: 1000;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
        }

        .task-list-btn:hover {
            background: #6c757d;
            color: white;
            transform: translateY(-2px);
        }

        .address-input {
            position: absolute;
            bottom: 90px;
            right: 20px;
            background: rgba(255,255,255,0.95);
            padding: 20px;
            border-radius: 12px;
            z-index: 1000;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            min-width: 320px;
        }

        .address-input label {
            display: block;
            margin-bottom: 12px;
            font-weight: bold;
            color: #333;
            font-size: 16px;
        }

        .address-input input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
        }

        .address-input input:focus {
            border-color: #007bff;
            outline: none;
        }

        .marker-popup {
            position: absolute;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            z-index: 1001;
            max-width: 500px;
            min-width: 450px;
            display: none;
            border: 3px solid #007bff;
        }

        .marker-popup h3 {
            margin-bottom: 20px;
            color: #333;
            border-bottom: 2px solid #eee;
            padding-bottom: 15px;
            font-size: 24px;
            line-height: 1.3;
        }

        .marker-popup p {
            margin: 12px 0;
            font-size: 18px;
            color: #555;
            line-height: 1.5;
        }

        .marker-popup .respond-btn {
            width: 100%;
            padding: 18px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
            margin-top: 20px;
            transition: all 0.3s ease;
        }

        .marker-popup .respond-btn:hover {
            background: #0056b3;
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0,0,0,0.2);
        }

        .route-choice-popup {
            position: absolute;
            background: white;
            border-radius: 15px;
            padding: 35px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            z-index: 1002;
            max-width: 450px;
            min-width: 400px;
            display: none;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            border: 3px solid #28a745;
        }

        .route-choice-popup h3 {
            margin-bottom: 25px;
            color: #333;
            text-align: center;
            font-size: 24px;
        }

        .route-choice-btn {
            width: 100%;
            padding: 18px;
            margin: 12px 0;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .route-choice-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0,0,0,0.2);
        }

        .route-choice-btn.location {
            background: #28a745;
        }

        .route-choice-btn.location:hover {
            background: #218838;
        }

        .route-choice-btn.address {
            background: #ffc107;
            color: #333;
        }

        .route-choice-btn.address:hover {
            background: #e0a800;
        }

        .close-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #999;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .close-btn:hover {
            background: #f8f9fa;
            color: #333;
        }

        .disability-badge {
            display: inline-block;
            padding: 6px 15px;
            background: #ff6b6b;
            color: white;
            border-radius: 20px;
            font-size: 16px;
            font-weight: bold;
            margin-left: 12px;
        }

        .urgent-badge {
            display: inline-block;
            padding: 6px 15px;
            background: #dc3545;
            color: white;
            border-radius: 20px;
            font-size: 16px;
            font-weight: bold;
            margin-left: 12px;
            animation: pulse 2s infinite;
        }

        .route-info {
            position: absolute;
            top: 200px;
            left: 20px;
            background: rgba(255,255,255,0.95);
            padding: 15px 20px;
            border-radius: 10px;
            font-size: 16px;
            z-index: 1000;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            max-width: 300px;
            display: none;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ */
        @media (max-width: 768px) {
            .control-panel {
                top: 120px;
                right: 10px;
                left: 10px;
                min-width: auto;
            }
            
            .volunteer-title {
                top: 10px;
                left: 10px;
                right: 10px;
                font-size: 22px;
                padding: 15px 20px;
            }
            
            .coordinates {
                top: 80px;
                left: 10px;
                right: 10px;
                max-width: none;
            }
            
            .address-input {
                bottom: 80px;
                left: 10px;
                right: 10px;
                min-width: auto;
            }
            
            .status {
                bottom: 150px;
                left: 10px;
                right: 10px;
                max-width: none;
            }
        }
    </style>
</head>
<body>
    <div id="map"></div>
    
    <div class="volunteer-title">
        –Ø - –í–æ–ª–æ–Ω—Ç—ë—Ä!
    </div>
    
    <div class="control-panel">
        <button class="btn location-btn" onclick="getUserLocation()">
            üéØ –ú–æ—ë –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ
        </button>
        <button class="btn" onclick="startTracking()" style="border-color: #ffc107;">
            üîÑ –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ
        </button>
        <button class="btn" onclick="stopTracking()" style="border-color: #dc3545;">
            ‚èπÔ∏è –ü—Ä–µ–∫—Ä–∞—Ç–∏—Ç—å –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å
        </button>
        <button class="btn" onclick="showMoscow()">
            üè¢ –ú–æ—Å–∫–≤–∞
        </button>
        <button class="btn" onclick="clearRoute()" style="border-color: #6c757d;">
            üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç
        </button>
    </div>

    <div class="address-input">
        <label for="userAddress">–í–≤–µ–¥–∏—Ç–µ —Å–≤–æ–π –∞–¥—Ä–µ—Å:</label>
        <input type="text" id="userAddress" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ú–æ—Å–∫–≤–∞, —É–ª. –¢–≤–µ—Ä—Å–∫–∞—è, 1">
    </div>

    <button class="task-list-btn" onclick="toggleTaskList()">
        ‚ò∞ –ó–∞–¥–∞—á–∏
    </button>
    
    <div class="coordinates" id="coordinates">
        –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã
    </div>
    
    <div class="status" id="status">
        –ö–∞—Ä—Ç–∞ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è...
    </div>

    <div class="route-info" id="routeInfo">
        <strong>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –º–∞—Ä—à—Ä—É—Ç–µ:</strong>
        <div id="routeDetails">–ú–∞—Ä—à—Ä—É—Ç –Ω–µ –ø–æ—Å—Ç—Ä–æ–µ–Ω</div>
    </div>

    <div class="marker-popup" id="markerPopup">
        <button class="close-btn" onclick="closePopup()">√ó</button>
        <h3 id="popupName"></h3>
        <p><strong>–í–æ–∑—Ä–∞—Å—Ç:</strong> <span id="popupAge"></span></p>
        <p><strong>–¢–∏–ø –∏–Ω–≤–∞–ª–∏–¥–Ω–æ—Å—Ç–∏:</strong> <span id="popupDisability"></span></p>
        <p><strong>–û–ø–∏—Å–∞–Ω–∏–µ –ø–æ–º–æ—â–∏:</strong> <span id="popupDescription"></span></p>
        <p><strong>–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è:</strong> <span id="popupDateTime"></span></p>
        <button class="respond-btn" onclick="showRouteChoice()">üó∫Ô∏è –û—Ç–∫–ª–∏–∫–Ω—É—Ç—å—Å—è –Ω–∞ –ø–æ–º–æ—â—å</button>
    </div>

    <div class="route-choice-popup" id="routeChoicePopup">
        <button class="close-btn" onclick="closeRouteChoicePopup()">√ó</button>
        <h3>–í—ã–±–µ—Ä–∏—Ç–µ –Ω–∞—á–∞–ª–æ –º–∞—Ä—à—Ä—É—Ç–∞</h3>
        <button class="route-choice-btn location" onclick="buildRouteFromLocation()">
            üìç –û—Ç –º–æ–µ–≥–æ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è
        </button>
        <button class="route-choice-btn address" onclick="buildRouteFromAddress()">
            üè† –û—Ç –≤–≤–µ–¥–µ–Ω–Ω–æ–≥–æ –∞–¥—Ä–µ—Å–∞
        </button>
    </div>

    <script src="https://mapgl.2gis.com/api/js/v1"></script>
    <script>
        let map;
        let userMarker;
        let watchId = null;
        let routeLine = null;
        let startMarker = null;
        let endMarker = null;
        let helpMarkers = [];
        let currentMarkerData = null;

        const helpRequests = [
            {
                id: 1,
                coordinates: [37.6175, 55.7558],
                name: "–ò–≤–∞–Ω–æ–≤–∞ –ú–∞—Ä–∏—è –ü–µ—Ç—Ä–æ–≤–Ω–∞",
                age: 72,
                disability: "–û–ø–æ—Ä–Ω–æ-–¥–≤–∏–≥–∞—Ç–µ–ª—å–Ω—ã–π –∞–ø–ø–∞—Ä–∞—Ç",
                description: "–ù—É–∂–Ω–∞ –ø–æ–º–æ—â—å —Å –ø–æ–∫—É–ø–∫–æ–π –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –∏ –ª–µ–∫–∞—Ä—Å—Ç–≤ –≤ –±–ª–∏–∂–∞–π—à–µ–π –∞–ø—Ç–µ–∫–µ –∏ –º–∞–≥–∞–∑–∏–Ω–µ",
                datetime: "07.10.2025, 14:00",
                urgent: false
            },
            {
                id: 2,
                coordinates: [37.6100, 55.7520],
                name: "–ü–µ—Ç—Ä–æ–≤ –ê–ª–µ–∫—Å–µ–π –°–µ—Ä–≥–µ–µ–≤–∏—á",
                age: 68,
                disability: "–ù–∞—Ä—É—à–µ–Ω–∏–µ –∑—Ä–µ–Ω–∏—è",
                description: "–¢—Ä–µ–±—É–µ—Ç—Å—è —Å–æ–ø—Ä–æ–≤–æ–∂–¥–µ–Ω–∏–µ –≤ –ø–æ–ª–∏–∫–ª–∏–Ω–∏–∫—É ‚Ññ5 –¥–ª—è –ø–ª–∞–Ω–æ–≤–æ–≥–æ –æ—Å–º–æ—Ç—Ä–∞",
                datetime: "08.10.2025, 10:30",
                urgent: true
            },
            {
                id: 3,
                coordinates: [37.6250, 55.7580],
                name: "–°–∏–¥–æ—Ä–æ–≤–∞ –ê–Ω–Ω–∞ –ò–≤–∞–Ω–æ–≤–Ω–∞",
                age: 75,
                disability: "–û–ø–æ—Ä–Ω–æ-–¥–≤–∏–≥–∞—Ç–µ–ª—å–Ω—ã–π –∞–ø–ø–∞—Ä–∞—Ç",
                description: "–ü–æ–º–æ—â—å –≤ —É–±–æ—Ä–∫–µ –∫–≤–∞—Ä—Ç–∏—Ä—ã (–≤–ª–∞–∂–Ω–∞—è —É–±–æ—Ä–∫–∞, –≤—ã–Ω–æ—Å –º—É—Å–æ—Ä–∞)",
                datetime: "09.10.2025, 12:00",
                urgent: false
            },
            {
                id: 4,
                coordinates: [37.6000, 55.7500],
                name: "–ö–æ–∑–ª–æ–≤ –í–ª–∞–¥–∏–º–∏—Ä –ù–∏–∫–æ–ª–∞–µ–≤–∏—á",
                age: 80,
                disability: "–ù–∞—Ä—É—à–µ–Ω–∏–µ —Å–ª—É—Ö–∞",
                description: "–ü–æ–º–æ—â—å —Å –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ–º –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –≤ —Å–æ—Ü–∏–∞–ª—å–Ω–æ–π —Å–ª—É–∂–±–µ",
                datetime: "10.10.2025, 11:00",
                urgent: false
            },
            {
                id: 5,
                coordinates: [37.6300, 55.7600],
                name: "–ù–∏–∫–æ–ª–∞–µ–≤–∞ –û–ª—å–≥–∞ –í–∞—Å–∏–ª—å–µ–≤–Ω–∞",
                age: 78,
                disability: "–û–±—â–µ–µ –∑–∞–±–æ–ª–µ–≤–∞–Ω–∏–µ",
                description: "–ù—É–∂–Ω–∞ –ø–æ–º–æ—â—å –ø–æ –¥–æ–º—É: –ø—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏–µ –µ–¥—ã, —É–±–æ—Ä–∫–∞",
                datetime: "11.10.2025, 15:00",
                urgent: false
            },
            {
                id: 6,
                coordinates: [37.6150, 55.7450],
                name: "–§—ë–¥–æ—Ä–æ–≤ –°–µ—Ä–≥–µ–π –ò–≤–∞–Ω–æ–≤–∏—á",
                age: 65,
                disability: "–ù–∞—Ä—É—à–µ–Ω–∏–µ –∑—Ä–µ–Ω–∏—è",
                description: "–°–æ–ø—Ä–æ–≤–æ–∂–¥–µ–Ω–∏–µ –≤ –±–∞–Ω–∫ –¥–ª—è –æ–ø–ª–∞—Ç—ã –∫–æ–º–º—É–Ω–∞–ª—å–Ω—ã—Ö —É—Å–ª—É–≥",
                datetime: "12.10.2025, 13:30",
                urgent: true
            },
            {
                id: 7,
                coordinates: [37.6050, 55.7650],
                name: "–ú–æ—Ä–æ–∑–æ–≤–∞ –ï–ª–µ–Ω–∞ –í–∏–∫—Ç–æ—Ä–æ–≤–Ω–∞",
                age: 82,
                disability: "–û–ø–æ—Ä–Ω–æ-–¥–≤–∏–≥–∞—Ç–µ–ª—å–Ω—ã–π –∞–ø–ø–∞—Ä–∞—Ç",
                description: "–ü–æ–º–æ—â—å —Å –¥–æ—Å—Ç–∞–≤–∫–æ–π —Ç—è–∂–µ–ª—ã—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –∏–∑ —Å—É–ø–µ—Ä–º–∞—Ä–∫–µ—Ç–∞",
                datetime: "13.10.2025, 16:00",
                urgent: false
            },
            {
                id: 8,
                coordinates: [37.6350, 55.7500],
                name: "–ì—Ä–æ–º–æ–≤ –ü–∞–≤–µ–ª –ê–ª–µ–∫—Å–∞–Ω–¥—Ä–æ–≤–∏—á",
                age: 70,
                disability: "–û–±—â–µ–µ –∑–∞–±–æ–ª–µ–≤–∞–Ω–∏–µ",
                description: "–ù—É–∂–Ω–∞ –ø–æ–º–æ—â—å –≤ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–∏ –∞–Ω–∫–µ—Ç –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ª—å–≥–æ—Ç",
                datetime: "14.10.2025, 09:00",
                urgent: false
            },
            {
                id: 9,
                coordinates: [37.6200, 55.7400],
                name: "–í–æ–ª–∫–æ–≤–∞ –ò—Ä–∏–Ω–∞ –°–µ—Ä–≥–µ–µ–≤–Ω–∞",
                age: 74,
                disability: "–ù–∞—Ä—É—à–µ–Ω–∏–µ —Å–ª—É—Ö–∞",
                description: "–°–æ–ø—Ä–æ–≤–æ–∂–¥–µ–Ω–∏–µ –Ω–∞ –ø–æ—á—Ç—É –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø–æ—Å—ã–ª–∫–∏ —Ä–æ–¥—Å—Ç–≤–µ–Ω–Ω–∏–∫–∞–º",
                datetime: "15.10.2025, 14:30",
                urgent: false
            },
            {
                id: 10,
                coordinates: [37.6400, 55.7550],
                name: "–¢–∏—Ö–æ–Ω–æ–≤ –ú–∏—Ö–∞–∏–ª –ü–µ—Ç—Ä–æ–≤–∏—á",
                age: 79,
                disability: "–û–ø–æ—Ä–Ω–æ-–¥–≤–∏–≥–∞—Ç–µ–ª—å–Ω—ã–π –∞–ø–ø–∞—Ä–∞—Ç",
                description: "–ü–æ–º–æ—â—å –≤ –ø—Ä–æ–≥—É–ª–∫–µ –Ω–∞ —Å–≤–µ–∂–µ–º –≤–æ–∑–¥—É—Ö–µ –≤ –ø–∞—Ä–∫–µ",
                datetime: "16.10.2025, 11:00",
                urgent: false
            }
        ];

        function initMap() {
            map = new mapgl.Map('map', {
                center: [37.6175, 55.7558],
                zoom: 13,
                key: '783e0858-39de-4c83-a72c-bc2858c795be',
            });

            map.on('click', function(event) {
                const coords = event.lngLat;
                updateCoordinates([coords.lng, coords.lat], null);
            });

            setTimeout(() => {
                addHelpMarkers();
            }, 1000);
        }

        function addHelpMarkers() {
            helpRequests.forEach(request => {
                const markerColor = request.urgent ? '#dc3545' : '#007bff';
                
                const marker = new mapgl.Marker(map, {
                    coordinates: request.coordinates,
                    icon: 'https://docs.2gis.com/img/mapgl/marker.svg',
                    color: markerColor,
                    size: [50, 50],
                });

                marker.on('click', () => {
                    showMarkerPopup(request);
                });

                helpMarkers.push(marker);
            });
            
            updateStatus(`–î–æ—Å—Ç—É–ø–Ω–æ: ${helpMarkers.length} –º–∞—Ä–∫–µ—Ä–æ–≤ –ø–æ–º–æ—â–∏. –ù–∞–∂–º–∏—Ç–µ –Ω–∞ –ª—é–±–æ–π –º–∞—Ä–∫–µ—Ä`);
        }

        function showMarkerPopup(data) {
            currentMarkerData = data;
            
            document.getElementById('popupName').innerHTML = data.name + 
                (data.urgent ? '<span class="urgent-badge">–°–†–û–ß–ù–û</span>' : '');
            document.getElementById('popupAge').textContent = data.age + ' –ª–µ—Ç';
            document.getElementById('popupDisability').textContent = data.disability;
            document.getElementById('popupDescription').textContent = data.description;
            document.getElementById('popupDateTime').textContent = data.datetime;
            
            const popup = document.getElementById('markerPopup');
            popup.style.display = 'block';
            popup.style.left = '50%';
            popup.style.top = '50%';
            popup.style.transform = 'translate(-50%, -50%)';
        }

        function closePopup() {
            document.getElementById('markerPopup').style.display = 'none';
            currentMarkerData = null;
        }

        function showRouteChoice() {
            closePopup();
            document.getElementById('routeChoicePopup').style.display = 'block';
        }

        function closeRouteChoicePopup() {
            document.getElementById('routeChoicePopup').style.display = 'none';
        }

        function buildRouteFromLocation() {
            closeRouteChoicePopup();
            
            if (!currentMarkerData) return;
            
            clearRoute();
            
            if (userMarker) {
                const userCoords = userMarker.getCoordinates();
                buildRouteFromCurrentLocation(userCoords, currentMarkerData.coordinates);
            } else {
                getUserLocationForRoute(currentMarkerData.coordinates);
            }
        }

        async function buildRouteFromAddress() {
            closeRouteChoicePopup();
            
            if (!currentMarkerData) return;
            
            const userAddress = document.getElementById('userAddress').value;
            if (!userAddress) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –≤–∞—à –∞–¥—Ä–µ—Å');
                return;
            }

            updateStatus('–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –∞–¥—Ä–µ—Å–∞...');

            try {
                const startCoords = await geocodeAddress(userAddress);
                buildRouteFromCurrentLocation([startCoords.lon, startCoords.lat], currentMarkerData.coordinates);
            } catch (error) {
                updateStatus('–û—à–∏–±–∫–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∞–¥—Ä–µ—Å–∞');
                alert('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –≤–≤–µ–¥–µ–Ω–Ω–æ–≥–æ –∞–¥—Ä–µ—Å–∞');
            }
        }

        async function geocodeAddress(address) {
            try {
                const response = await fetch(`https://catalog.api.2gis.com/3.0/items/geocode?q=${encodeURIComponent(address)}&fields=items.point&key=40074715-85b5-400f-a2a8-a41b550be1e8`);
                
                if (!response.ok) {
                    throw new Error(`–û—à–∏–±–∫–∞ –≥–µ–æ–∫–æ–¥–∏–Ω–≥–∞: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.result && data.result.items && data.result.items.length > 0) {
                    const point = data.result.items[0].point;
                    return {
                        lon: point.lon,
                        lat: point.lat
                    };
                } else {
                    throw new Error('–ê–¥—Ä–µ—Å –Ω–µ –Ω–∞–π–¥–µ–Ω');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –≥–µ–æ–∫–æ–¥–∏–Ω–≥–∞:', error);
                throw error;
            }
        }

        function getUserLocationForRoute(destinationCoords) {
            if (!navigator.geolocation) {
                alert('–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤–∞—à–∏–º –±—Ä–∞—É–∑–µ—Ä–æ–º');
                return;
            }

            updateStatus('–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è –¥–ª—è –º–∞—Ä—à—Ä—É—Ç–∞...');

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const userCoords = [position.coords.longitude, position.coords.latitude];
                    showUserLocation(userCoords, position.coords.accuracy);
                    buildRouteFromCurrentLocation(userCoords, destinationCoords);
                },
                (error) => {
                    handleLocationError(error);
                    alert('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –≤–∞—à–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –º–∞—Ä—à—Ä—É—Ç–∞');
                }
            );
        }

        async function buildRouteFromCurrentLocation(startCoords, endCoords) {
            updateStatus('–ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –º–∞—Ä—à—Ä—É—Ç–∞...');

            try {
                // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –º–∞—Ä–∫–µ—Ä—ã –∏ –º–∞—Ä—à—Ä—É—Ç
                if (startMarker) startMarker.destroy();
                if (endMarker) endMarker.destroy();

                // –°–æ–∑–¥–∞–µ–º –º–∞—Ä–∫–µ—Ä—ã –Ω–∞—á–∞–ª–∞ –∏ –∫–æ–Ω—Ü–∞
                startMarker = new mapgl.Marker(map, {
                    coordinates: startCoords,
                    icon: 'https://docs.2gis.com/img/mapgl/marker.svg',
                    color: '#28a745',
                    size: [45, 45]
                });

                endMarker = new mapgl.Marker(map, {
                    coordinates: endCoords,
                    icon: 'https://docs.2gis.com/img/mapgl/marker.svg',
                    color: '#dc3545',
                    size: [45, 45]
                });

                // –ò—Å–ø–æ–ª—å–∑—É–µ–º Directions API –¥–ª—è –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –º–∞—Ä—à—Ä—É—Ç–∞
                const response = await fetch(`https://routing.api.2gis.com/getRoute?key=f9fec7ee-27e4-4dd2-bccd-61b3ee664093&points=${startCoords[1]},${startCoords[0]};${endCoords[1]},${endCoords[0]}&type=pedestrian`);

                if (!response.ok) {
                    throw new Error('–û—à–∏–±–∫–∞ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –º–∞—Ä—à—Ä—É—Ç–∞');
                }

                const data = await response.json();
                
                if (data.result && data.result.path) {
                    displayRoute(data.result.path);
                } else {
                    // –ï—Å–ª–∏ API –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª–æ, —Å—Ç—Ä–æ–∏–º –ø—Ä—è–º—É—é –ª–∏–Ω–∏—é
                    displaySimpleRoute(startCoords, endCoords);
                }

            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –º–∞—Ä—à—Ä—É—Ç–∞:', error);
                // –°—Ç—Ä–æ–∏–º –ø—Ä–æ—Å—Ç–æ–π –º–∞—Ä—à—Ä—É—Ç –∫–∞–∫ –∑–∞–ø–∞—Å–Ω–æ–π –≤–∞—Ä–∏–∞–Ω—Ç
                displaySimpleRoute(startCoords, endCoords);
            }
        }

        function displayRoute(routePath) {
            if (routeLine) {
                routeLine.destroy();
            }

            // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –º–∞—Ä—à—Ä—É—Ç–∞ –≤ –Ω—É–∂–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç
            const coordinates = routePath.map(point => [point[1], point[0]]);

            routeLine = new mapgl.Polyline(map, {
                coordinates: coordinates,
                width: 6,
                color: "#007bff",
                opacity: 0.8
            });

            // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –º–∞—Ä—à—Ä—É—Ç–∞
            const distance = calculateRouteDistance(coordinates);
            const routeInfo = document.getElementById('routeInfo');
            const routeDetails = document.getElementById('routeDetails');
            
            routeDetails.innerHTML = `
                –†–∞—Å—Å—Ç–æ—è–Ω–∏–µ: ${distance} –∫–º<br>
                –ü—Ä–∏–º–µ—Ä–Ω–æ–µ –≤—Ä–µ–º—è: ${Math.round(distance * 15)} –º–∏–Ω
            `;
            routeInfo.style.display = 'block';

            updateStatus('–ú–∞—Ä—à—Ä—É—Ç –ø–æ—Å—Ç—Ä–æ–µ–Ω —É—Å–ø–µ—à–Ω–æ!');
        }

        function displaySimpleRoute(startCoords, endCoords) {
            if (routeLine) {
                routeLine.destroy();
            }

            // –°–æ–∑–¥–∞–µ–º –ø—Ä–æ—Å—Ç—É—é –ø—Ä—è–º—É—é –ª–∏–Ω–∏—é –º–µ–∂–¥—É —Ç–æ—á–∫–∞–º–∏
            routeLine = new mapgl.Polyline(map, {
                coordinates: [startCoords, endCoords],
                width: 6,
                color: "#007bff",
                opacity: 0.8
            });

            const distance = calculateSimpleDistance(startCoords, endCoords);
            const routeInfo = document.getElementById('routeInfo');
            const routeDetails = document.getElementById('routeDetails');
            
            routeDetails.innerHTML = `
                –†–∞—Å—Å—Ç–æ—è–Ω–∏–µ: ${distance} –∫–º<br>
                –ü—Ä–∏–º–µ—Ä–Ω–æ–µ –≤—Ä–µ–º—è: ${Math.round(distance * 15)} –º–∏–Ω<br>
                <small>(–ø—Ä—è–º–æ–π –º–∞—Ä—à—Ä—É—Ç)</small>
            `;
            routeInfo.style.display = 'block';

            updateStatus('–ú–∞—Ä—à—Ä—É—Ç –ø–æ—Å—Ç—Ä–æ–µ–Ω (–ø—Ä—è–º–∞—è –ª–∏–Ω–∏—è)');
        }

        function calculateRouteDistance(coordinates) {
            let totalDistance = 0;
            for (let i = 1; i < coordinates.length; i++) {
                totalDistance += calculateSimpleDistance(coordinates[i-1], coordinates[i]);
            }
            return (totalDistance).toFixed(1);
        }

        function calculateSimpleDistance(coord1, coord2) {
            const R = 6371; // –†–∞–¥–∏—É—Å –ó–µ–º–ª–∏ –≤ –∫–º
            const dLat = (coord2[1] - coord1[1]) * Math.PI / 180;
            const dLon = (coord2[0] - coord1[0]) * Math.PI / 180;
            const a = 
                Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(coord1[1] * Math.PI / 180) * Math.cos(coord2[1] * Math.PI / 180) * 
                Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return (R * c).toFixed(1);
        }

        function showMoscow() {
            if (map) {
                map.setCenter([37.6175, 55.7558]);
                map.setZoom(13);
                updateStatus('–ö–∞—Ä—Ç–∞ —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∞ –Ω–∞ –ú–æ—Å–∫–≤–µ');
            }
        }

        function getUserLocation() {
            if (!navigator.geolocation) {
                alert('–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤–∞—à–∏–º –±—Ä–∞—É–∑–µ—Ä–æ–º');
                return;
            }

            updateStatus('–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è...');

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const coords = [position.coords.longitude, position.coords.latitude];
                    showUserLocation(coords, position.coords.accuracy);
                    updateStatus('–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ!');
                },
                (error) => {
                    handleLocationError(error);
                }
            );
        }

        function startTracking() {
            if (!navigator.geolocation) {
                alert('–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤–∞—à–∏–º –±—Ä–∞—É–∑–µ—Ä–æ–º');
                return;
            }

            if (watchId) {
                alert('–û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —É–∂–µ –∞–∫—Ç–∏–≤–Ω–æ');
                return;
            }

            updateStatus('–ù–∞—á–∞—Ç–æ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è...');

            watchId = navigator.geolocation.watchPosition(
                (position) => {
                    const coords = [position.coords.longitude, position.coords.latitude];
                    showUserLocation(coords, position.coords.accuracy);
                    updateStatus('–û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ');
                },
                (error) => {
                    handleLocationError(error);
                    stopTracking();
                }
            );
        }

        function showUserLocation(coords, accuracy) {
            if (!map) return;

            if (userMarker) {
                userMarker.destroy();
            }

            userMarker = new mapgl.Marker(map, {
                coordinates: coords,
                icon: 'https://docs.2gis.com/img/mapgl/marker.svg',
                color: '#28a745',
                size: [45, 45]
            });

            map.setCenter(coords);
            map.setZoom(16);
            updateCoordinates(coords, accuracy);
        }

        function updateCoordinates(coords, accuracy) {
            const coordsElement = document.getElementById('coordinates');
            if (coordsElement) {
                coordsElement.innerHTML = `
                    <strong>–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã:</strong><br>
                    –®–∏—Ä–æ—Ç–∞: ${coords[1].toFixed(6)}<br>
                    –î–æ–ª–≥–æ—Ç–∞: ${coords[0].toFixed(6)}<br>
                    –¢–æ—á–Ω–æ—Å—Ç—å: ${accuracy ? accuracy.toFixed(0) + ' –º' : '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}
                `;
            }
        }

        function handleLocationError(error) {
            let message = '';
            
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    message = '–î–æ—Å—Ç—É–ø –∫ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏ –∑–∞–ø—Ä–µ—â–µ–Ω';
                    break;
                case error.POSITION_UNAVAILABLE:
                    message = '–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞';
                    break;
                case error.TIMEOUT:
                    message = '–í—Ä–µ–º—è –∑–∞–ø—Ä–æ—Å–∞ –∏—Å—Ç–µ–∫–ª–æ';
                    break;
                default:
                    message = '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞';
                    break;
            }
            
            updateStatus('–û—à–∏–±–∫–∞: ' + message);
        }

        function updateStatus(text) {
            const statusElement = document.getElementById('status');
            if (statusElement) {
                statusElement.textContent = text;
            }
        }

        function stopTracking() {
            if (watchId) {
                navigator.geolocation.clearWatch(watchId);
                watchId = null;
                updateStatus('–û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ');
            }
        }

        function clearRoute() {
            if (routeLine) {
                routeLine.destroy();
                routeLine = null;
            }
            if (startMarker) {
                startMarker.destroy();
                startMarker = null;
            }
            if (endMarker) {
                endMarker.destroy();
                endMarker = null;
            }
            
            document.getElementById('routeInfo').style.display = 'none';
            updateStatus('–ú–∞—Ä—à—Ä—É—Ç –æ—á–∏—â–µ–Ω');
        }

        function toggleTaskList() {
            alert('–§—É–Ω–∫—Ü–∏—è —Å–ø–∏—Å–∫–∞ –∑–∞–¥–∞—á –±—É–¥–µ—Ç —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –≤ –±—É–¥—É—â–µ–º');
        }

        window.addEventListener('load', initMap);

        window.addEventListener('beforeunload', () => {
            stopTracking();
        });
    </script>
</body>
</html>