<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2Inclusion</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        html, body {
            width: 100%;
            height: 100%;
            font-family: Arial, sans-serif;
            font-size: 16px;
        }
        
        #map {
            width: 100%;
            height: 100%;
        }
        
        .control-panel {
            position: absolute;
            top: 100px;
            right: 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 12px;
            background: rgba(255,255,255,0.95);
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            min-width: 280px;
        }
        
        .btn {
            padding: 15px 20px;
            background: white;
            border: 2px solid #007bff;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            color: #333;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            transition: all 0.3s ease;
            text-align: center;
        }
        
        .btn:hover {
            background: #007bff;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        
        .location-btn {
            border-color: #28a745;
            background: #28a745;
            color: white;
        }
        
        .location-btn:hover {
            background: #218838;
            border-color: #218838;
        }
        
        .status {
            position: absolute;
            bottom: 90px;
            left: 20px;
            background: rgba(255,255,255,0.95);
            padding: 15px 20px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            z-index: 1000;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            max-width: 300px;
        }
        
        .coordinates {
            position: absolute;
            top: 100px;
            left: 20px;
            background: rgba(255,255,255,0.95);
            padding: 15px 20px;
            border-radius: 10px;
            font-size: 14px;
            z-index: 1000;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            max-width: 250px;
        }

        .volunteer-title {
            position: absolute;
            top: 20px;
            left: 20px;
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            padding: 20px 30px;
            border-radius: 12px;
            font-size: 28px;
            font-weight: bold;
            z-index: 1000;
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
            text-align: center;
            line-height: 1.2;
        }

        .task-list-btn {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: white;
            border: 2px solid #6c757d;
            border-radius: 10px;
            cursor: pointer;
            font-size: 24px;
            padding: 15px 20px;
            z-index: 1000;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
        }

        .task-list-btn:hover {
            background: #6c757d;
            color: white;
            transform: translateY(-2px);
        }

        .address-input {
            position: absolute;
            bottom: 90px;
            right: 20px;
            background: rgba(255,255,255,0.95);
            padding: 20px;
            border-radius: 12px;
            z-index: 1000;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            min-width: 320px;
        }

        .address-input label {
            display: block;
            margin-bottom: 12px;
            font-weight: bold;
            color: #333;
            font-size: 16px;
        }

        .address-input-group {
            display: flex;
            gap: 10px;
        }

        .address-input input {
            flex: 1;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
        }

        .address-input input:focus {
            border-color: #007bff;
            outline: none;
        }

        .address-input .apply-btn {
            padding: 12px 20px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            white-space: nowrap;
            transition: all 0.3s ease;
        }

        .address-input .apply-btn:hover {
            background: #218838;
            transform: translateY(-1px);
        }

        .saved-address {
            margin-top: 10px;
            padding: 10px;
            background: #e9f7ef;
            border: 1px solid #28a745;
            border-radius: 6px;
            font-size: 14px;
        }

        .saved-address strong {
            color: #28a745;
        }

        /* Стиль филтров.. */
        .filters-panel {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: rgba(255,255,255,0.95);
            padding: 20px;
            border-radius: 12px;
            z-index: 1000;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            min-width: 300px;
            max-width: 400px;
        }

        .filters-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 15px;
        }

        .filters-header h3 {
            color: #333;
            font-size: 18px;
            margin: 0;
        }

        .filter-group {
            margin-bottom: 15px;
        }

        .filter-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
            font-size: 14px;
        }

        .filter-group select,
        .filter-group input {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }

        .filter-group select:focus,
        .filter-group input:focus {
            border-color: #007bff;
            outline: none;
        }

        .filter-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .filter-btn {
            flex: 1;
            padding: 12px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .filter-btn:hover {
            background: #0056b3;
            transform: translateY(-1px);
        }

        .filter-btn.reset {
            background: #6c757d;
        }

        .filter-btn.reset:hover {
            background: #545b62;
        }

        .filters-toggle {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            font-size: 20px;
            cursor: pointer;
            z-index: 1000;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
        }

        .filters-toggle:hover {
            background: #0056b3;
            transform: translateY(-2px);
        }

        .marker-popup {
            position: absolute;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            z-index: 1001;
            max-width: 500px;
            min-width: 450px;
            display: none;
            border: 3px solid #007bff;
        }

        .marker-popup h3 {
            margin-bottom: 20px;
            color: #333;
            border-bottom: 2px solid #eee;
            padding-bottom: 15px;
            font-size: 24px;
            line-height: 1.3;
        }

        .marker-popup p {
            margin: 12px 0;
            font-size: 18px;
            color: #555;
            line-height: 1.5;
        }

        .marker-popup .respond-btn {
            width: 100%;
            padding: 18px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
            margin-top: 20px;
            transition: all 0.3s ease;
        }

        .marker-popup .respond-btn:hover {
            background: #0056b3;
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0,0,0,0.2);
        }

        .route-choice-popup {
            position: absolute;
            background: white;
            border-radius: 15px;
            padding: 35px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            z-index: 1002;
            max-width: 450px;
            min-width: 400px;
            display: none;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            border: 3px solid #28a745;
        }

        .route-choice-popup h3 {
            margin-bottom: 25px;
            color: #333;
            text-align: center;
            font-size: 24px;
        }

        .route-choice-btn {
            width: 100%;
            padding: 18px;
            margin: 12px 0;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .route-choice-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0,0,0,0.2);
        }

        .route-choice-btn.location {
            background: #28a745;
        }

        .route-choice-btn.location:hover {
            background: #218838;
        }

        .route-choice-btn.address {
            background: #ffc107;
            color: #333;
        }

        .route-choice-btn.address:hover {
            background: #e0a800;
        }

        .close-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #999;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .close-btn:hover {
            background: #f8f9fa;
            color: #333;
        }

        .disability-badge {
            display: inline-block;
            padding: 6px 15px;
            background: #ff6b6b;
            color: white;
            border-radius: 20px;
            font-size: 16px;
            font-weight: bold;
            margin-left: 12px;
        }

        .urgent-badge {
            display: inline-block;
            padding: 6px 15px;
            background: #dc3545;
            color: white;
            border-radius: 20px;
            font-size: 16px;
            font-weight: bold;
            margin-left: 12px;
            animation: pulse 2s infinite;
        }

        .route-info {
            position: absolute;
            top: 200px;
            left: 20px;
            background: rgba(255,255,255,0.95);
            padding: 15px 20px;
            border-radius: 10px;
            font-size: 16px;
            z-index: 1000;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            max-width: 300px;
            display: none;
        }

        .filter-results {
            margin-top: 10px;
            padding: 8px;
            background: #e7f3ff;
            border-radius: 6px;
            font-size: 12px;
            text-align: center;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        /* Для мобилок */
        @media (max-width: 768px) {
            .control-panel {
                top: 120px;
                right: 10px;
                left: 10px;
                min-width: auto;
            }
            
            .volunteer-title {
                top: 10px;
                left: 10px;
                right: 10px;
                font-size: 22px;
                padding: 15px 20px;
            }
            
            .coordinates {
                top: 80px;
                left: 10px;
                right: 10px;
                max-width: none;
            }
            
            .address-input {
                bottom: 80px;
                left: 10px;
                right: 10px;
                min-width: auto;
            }
            
            .status {
                bottom: 150px;
                left: 10px;
                right: 10px;
                max-width: none;
            }

            .filters-panel {
                bottom: 10px;
                left: 10px;
                right: 10px;
                max-width: none;
            }
        }
    </style>
</head>
<body>
    <div id="map"></div>
    
    <div class="volunteer-title">
        Я - Волонтёр!
    </div>
    
    <div class="control-panel">
        <button class="btn location-btn" onclick="getUserLocation()">
            🎯 Моё местоположение
        </button>
        <button class="btn" onclick="showMoscow()">
            🏢 Москва
        </button>
    </div>

    <div class="address-input">
        <label for="userAddress">Введите свой адрес:</label>
        <div class="address-input-group">
            <input type="text" id="userAddress" placeholder="Например: Москва, ул. Тверская, 1">
            <button class="apply-btn" onclick="saveAddress()">✅ Применить</button>
        </div>
        <div class="saved-address" id="savedAddress" style="display: none;">
            <strong>Сохранённый адрес:</strong> <span id="savedAddressText"></span>
        </div>
    </div>

    <!-- ФИЛЬТРЫ -->
    <div class="filters-panel" id="filtersPanel" style="display: none;">
        <div class="filters-header">
            <h3>🔍 Фильтры поиска</h3>
            <button class="close-btn" onclick="toggleFilters()">×</button>
        </div>
        
        <div class="filter-group">
            <!-- Города можно будет добавлять -->
            <label for="cityFilter">Город:</label>
            <select id="cityFilter">
                <option value="all">Все города</option>
                <option value="Москва">Москва</option>
                <option value="Санкт-Петербург">Санкт-Петербург</option>
                <option value="Новосибирск">Новосибирск</option>
                <option value="Екатеринбург">Екатеринбург</option>
                <option value="Казань">Казань</option>
            </select>
        </div>

        <div class="filter-group">
            <label for="radiusFilter">Радиус поиска от адреса:</label>
            <select id="radiusFilter">
                <option value="0">Любой радиус</option>
                <option value="1">1 км</option>
                <option value="3">3 км</option>
                <option value="5">5 км</option>
                <option value="10">10 км</option>
                <option value="15">15 км</option>
            </select>
        </div>

        <div class="filter-group">
            <label for="disabilityFilter">Тип инвалидности:</label>
            <select id="disabilityFilter">
                <option value="all">Все типы</option>
                <option value="Опорно-двигательный аппарат">Опорно-двигательный аппарат</option>
                <option value="Нарушение зрения">Нарушение зрения</option>
                <option value="Нарушение слуха">Нарушение слуха</option>
                <option value="Общее заболевание">Общее заболевание</option>
            </select>
        </div>

        <div class="filter-group">
            <label for="urgencyFilter">Срочность:</label>
            <select id="urgencyFilter">
                <option value="all">Все заявки</option>
                <option value="urgent">Только срочные</option>
                <option value="normal">Только обычные</option>
            </select>
        </div>

        <div class="filter-results" id="filterResults">
            Показано: 10 из 10 заявок
        </div>

        <div class="filter-actions">
            <button class="filter-btn reset" onclick="resetFilters()">🔄 Сбросить</button>
            <button class="filter-btn" onclick="applyFilters()">✅ Применить фильтры</button>
        </div>
    </div>

    <button class="filters-toggle" id="filtersToggle" onclick="toggleFilters()">
        🔍
    </button>

    <button class="task-list-btn" onclick="toggleTaskList()">
        ☰ Задачи
    </button>
    
    <div class="coordinates" id="coordinates">
        Координаты: не определены
    </div>
    
    <div class="status" id="status">
        Карта загружается...
    </div>

    <div class="route-info" id="routeInfo">
        <strong>Информация о маршруте:</strong>
        <div id="routeDetails">Маршрут не построен</div>
    </div>

    <div class="marker-popup" id="markerPopup">
        <button class="close-btn" onclick="closePopup()">×</button>
        <h3 id="popupName"></h3>
        <p><strong>Возраст:</strong> <span id="popupAge"></span></p>
        <p><strong>Тип инвалидности:</strong> <span id="popupDisability"></span></p>
        <p><strong>Описание помощи:</strong> <span id="popupDescription"></span></p>
        <p><strong>Дата и время:</strong> <span id="popupDateTime"></span></p>
        <button class="respond-btn" onclick="showRouteChoice()">🗺️ Откликнуться на помощь</button>
    </div>

    <div class="route-choice-popup" id="routeChoicePopup">
        <button class="close-btn" onclick="closeRouteChoicePopup()">×</button>
        <h3>Выберите начало маршрута</h3>
        <button class="route-choice-btn location" onclick="buildRouteFromLocation()">
            📍 От моего местоположения
        </button>
        <button class="route-choice-btn address" onclick="buildRouteFromAddress()">
            🏠 От сохранённого адреса
        </button>
    </div>

    <script src="https://mapgl.2gis.com/api/js/v1"></script>
    <script>
        let map;
        let userMarker;
        let watchId = null;
        let routeLine = null;
        let startMarker = null;
        let endMarker = null;
        let helpMarkers = [];
        let currentMarkerData = null;
        let savedAddress = localStorage.getItem('savedAddress') || '';
        let savedAddressCoords = null;
        let allHelpRequests = [];
        let filteredHelpRequests = [];

        // Города и задачки для теста
        allHelpRequests = [
            // Москва
            {
                id: 1,
                coordinates: [37.6175, 55.7558],
                name: "Иванова Мария Петровна",
                age: 72,
                disability: "Опорно-двигательный аппарат",
                description: "Нужна помощь с покупкой продуктов и лекарств в ближайшей аптеке и магазине",
                datetime: "07.10.2025, 14:00",
                urgent: false,
                city: "Москва"
            },
            {
                id: 2,
                coordinates: [37.6100, 55.7520],
                name: "Петров Алексей Сергеевич",
                age: 68,
                disability: "Нарушение зрения",
                description: "Требуется сопровождение в поликлинику №5 для планового осмотра",
                datetime: "08.10.2025, 10:30",
                urgent: true,
                city: "Москва"
            },
            {
                id: 3,
                coordinates: [37.6250, 55.7580],
                name: "Сидорова Анна Ивановна",
                age: 75,
                disability: "Опорно-двигательный аппарат",
                description: "Помощь в уборке квартиры (влажная уборка, вынос мусора)",
                datetime: "09.10.2025, 12:00",
                urgent: false,
                city: "Москва"
            },
            {
                id: 4,
                coordinates: [37.6000, 55.7500],
                name: "Козлов Владимир Николаевич",
                age: 80,
                disability: "Нарушение слуха",
                description: "Помощь с оформлением документов в социальной службе",
                datetime: "10.10.2025, 11:00",
                urgent: false,
                city: "Москва"
            },
            {
                id: 5,
                coordinates: [37.6300, 55.7600],
                name: "Николаева Ольга Васильевна",
                age: 78,
                disability: "Общее заболевание",
                description: "Нужна помощь по дому: приготовление еды, уборка",
                datetime: "11.10.2025, 15:00",
                urgent: false,
                city: "Москва"
            },
            // Санкт-Петербург
            {
                id: 6,
                coordinates: [30.3155, 59.9375],
                name: "Фёдоров Сергей Иванович",
                age: 65,
                disability: "Нарушение зрения",
                description: "Сопровождение в банк для оплаты коммунальных услуг",
                datetime: "12.10.2025, 13:30",
                urgent: true,
                city: "Санкт-Петербург"
            },
            {
                id: 7,
                coordinates: [30.3255, 59.9275],
                name: "Морозова Елена Викторовна",
                age: 82,
                disability: "Опорно-двигательный аппарат",
                description: "Помощь с доставкой тяжелых продуктов из супермаркета",
                datetime: "13.10.2025, 16:00",
                urgent: false,
                city: "Санкт-Петербург"
            },
            // Новосибирск
            {
                id: 8,
                coordinates: [82.9204, 55.0084],
                name: "Громов Павел Александрович",
                age: 70,
                disability: "Общее заболевание",
                description: "Нужна помощь в заполнении анкет для получения льгот",
                datetime: "14.10.2025, 09:00",
                urgent: false,
                city: "Новосибирск"
            },
            // Екатеринбург
            {
                id: 9,
                coordinates: [60.6122, 56.8519],
                name: "Волкова Ирина Сергеевна",
                age: 74,
                disability: "Нарушение слуха",
                description: "Сопровождение на почту для отправки посылки родственникам",
                datetime: "15.10.2025, 14:30",
                urgent: false,
                city: "Екатеринбург"
            },
            // Казань
            {
                id: 10,
                coordinates: [49.1085, 55.7963],
                name: "Тихонов Михаил Петрович",
                age: 79,
                disability: "Опорно-двигательный аппарат",
                description: "Помощь в прогулке на свежем воздухе в парке",
                datetime: "16.10.2025, 11:00",
                urgent: false,
                city: "Казань"
            },

            {
                id: 11,
                coordinates: [37.6057, 55.7479],
                name: "Крючкова Любовь Васильевна",
                age: 56,
                disability: "Общее заболевание",
                description: "Помогите донести пакеты. До метро Октябрьская!!!",
                datetime: "07.10.2025, 7:00",
                urgent: false,
                city: "Москва"
            },
            {
                id: 12,
                coordinates: [37.6080, 55.6900],
                name: "Фезякина Ольга Андреевна",
                age: 45,
                disability: "Общее заболевание",
                description: "Нужна помощь с лекарствами.",
                datetime: "15.10.2025, 23:00",
                urgent: false,
                city: "Москва"
            },
            {
                id: 13,
                coordinates: [37.6085, 55.6940],
                name: "Андреев Сергей Викторович",
                age: 95,
                disability: "Общее заболевание",
                description: "довести. ребята. срочно",
                datetime: "15.10.2025, 23:00",
                urgent: true,
                city: "Москва"
            }
        ];

        filteredHelpRequests = [...allHelpRequests];

        function initMap() {
            map = new mapgl.Map('map', {
                center: [37.6175, 55.7558],
                zoom: 13,
                key: '783e0858-39de-4c83-a72c-bc2858c795be',
            });

            map.on('click', function(event) {
                const coords = event.lngLat;
                updateCoordinates([coords.lng, coords.lat], null);
            });

            // Восстанавливаем сохранённый адрес при загрузке
            if (savedAddress) {
                document.getElementById('userAddress').value = savedAddress;
                document.getElementById('savedAddressText').textContent = savedAddress;
                document.getElementById('savedAddress').style.display = 'block';
                // Получаем координаты сохранённого адреса
                geocodeAddress(savedAddress).then(coords => {
                    savedAddressCoords = [coords.lon, coords.lat];
                });
            }

            setTimeout(() => {
                addHelpMarkers();
            }, 1000);
        }

        function addHelpMarkers() {
            // Чистка прошлых маркеров
            helpMarkers.forEach(marker => marker.destroy());
            helpMarkers = [];

            filteredHelpRequests.forEach(request => {
                const markerColor = request.urgent ? '#dc3545' : '#007bff';
                
                const marker = new mapgl.Marker(map, {
                    coordinates: request.coordinates,
                    icon: 'https://docs.2gis.com/img/mapgl/marker.svg',
                    color: markerColor,
                    size: [50, 50],
                });

                marker.on('click', () => {
                    showMarkerPopup(request);
                });

                helpMarkers.push(marker);
            });
            
            updateFilterResults();
            updateStatus(`Показано: ${helpMarkers.length} из ${allHelpRequests.length} заявок`);
        }

        function updateFilterResults() {
            const resultsElement = document.getElementById('filterResults');
            resultsElement.textContent = `Показано: ${filteredHelpRequests.length} из ${allHelpRequests.length} заявок`;
        }

        function applyFilters() {
            const cityFilter = document.getElementById('cityFilter').value;
            const radiusFilter = parseInt(document.getElementById('radiusFilter').value);
            const disabilityFilter = document.getElementById('disabilityFilter').value;
            const urgencyFilter = document.getElementById('urgencyFilter').value;

            filteredHelpRequests = allHelpRequests.filter(request => {
                // Фильтр по городу
                if (cityFilter !== 'all' && request.city !== cityFilter) {
                    return false;
                }

                // Тип инвалидности
                if (disabilityFilter !== 'all' && request.disability !== disabilityFilter) {
                    return false;
                }

                // Срочность
                if (urgencyFilter === 'urgent' && !request.urgent) {
                    return false;
                }
                if (urgencyFilter === 'normal' && request.urgent) {
                    return false;
                }

                // фильтр по радиусу (если есть сохранённый (введённый) адрес) Не работает от местоположения !!
                if (radiusFilter > 0 && savedAddressCoords) {
                    const distance = calculateSimpleDistance(savedAddressCoords, request.coordinates);
                    if (distance > radiusFilter) {
                        return false;
                    }
                }

                return true;
            });

            addHelpMarkers();
            updateStatus(`Применены фильтры. Показано: ${filteredHelpRequests.length} заявок`);
        }

        function resetFilters() {
            document.getElementById('cityFilter').value = 'all';
            document.getElementById('radiusFilter').value = '0';
            document.getElementById('disabilityFilter').value = 'all';
            document.getElementById('urgencyFilter').value = 'all';
            
            filteredHelpRequests = [...allHelpRequests];
            addHelpMarkers();
            updateStatus('Фильтры сброшены');
        }

        function toggleFilters() {
            const filtersPanel = document.getElementById('filtersPanel');
            const filtersToggle = document.getElementById('filtersToggle');
            
            if (filtersPanel.style.display === 'none') {
                filtersPanel.style.display = 'block';
                filtersToggle.style.display = 'none';
            } else {
                filtersPanel.style.display = 'none';
                filtersToggle.style.display = 'block';
            }
        }

        function saveAddress() {
            const addressInput = document.getElementById('userAddress');
            const address = addressInput.value.trim();
            
            if (!address) {
                alert('Пожалуйста, введите адрес');
                return;
            }

            updateStatus('Сохранение адреса...');

            geocodeAddress(address).then(coords => {
                savedAddress = address;
                savedAddressCoords = [coords.lon, coords.lat];
                
                // Сохраняем в localStorage наш сохранённый адрес
                localStorage.setItem('savedAddress', address);
                
                // показываем сохранённый адрес
                document.getElementById('savedAddressText').textContent = address;
                document.getElementById('savedAddress').style.display = 'block';
                
                updateStatus('Адрес сохранён!');
                
                // Показываем маркер нашего адреса
                showSavedAddressMarker();
                
            }).catch(error => {
                updateStatus('Ошибка определения адреса');
                alert('Не удалось определить координаты введенного адреса. Проверьте правильность адреса.');
            });
        }

        function showSavedAddressMarker() {
            if (savedAddressCoords) {
                if (window.savedAddressMarker) {
                    window.savedAddressMarker.destroy();
                }
                
                window.savedAddressMarker = new mapgl.Marker(map, {
                    coordinates: savedAddressCoords,
                    icon: 'https://docs.2gis.com/img/mapgl/marker.svg',
                    color: '#ffc107',
                    size: [40, 40]
                });
            }
        }


        // Возможно остался мусор от методов построения маршрута....
        
        function showMarkerPopup(data) {
            currentMarkerData = data;
            
            document.getElementById('popupName').innerHTML = data.name + 
                (data.urgent ? '<span class="urgent-badge">СРОЧНО</span>' : '');
            document.getElementById('popupAge').textContent = data.age + ' лет';
            document.getElementById('popupDisability').textContent = data.disability;
            document.getElementById('popupDescription').textContent = data.description;
            document.getElementById('popupDateTime').textContent = data.datetime;
            
            const popup = document.getElementById('markerPopup');
            popup.style.display = 'block';
            popup.style.left = '50%';
            popup.style.top = '50%';
            popup.style.transform = 'translate(-50%, -50%)';
        }

        function closePopup() {
            document.getElementById('markerPopup').style.display = 'none';
            currentMarkerData = null;
        }

        function showRouteChoice() {
            closePopup();
            document.getElementById('routeChoicePopup').style.display = 'block';
        }

        function closeRouteChoicePopup() {
            document.getElementById('routeChoicePopup').style.display = 'none';
        }

        function buildRouteFromLocation() {
            closeRouteChoicePopup();
            
            if (!currentMarkerData) return;
            
            clearRoute();
            
            if (userMarker) {
                const userCoords = userMarker.getCoordinates();
                buildRoute(userCoords, currentMarkerData.coordinates, 'location');
            } else {
                getUserLocationForRoute(currentMarkerData.coordinates);
            }
        }

        

        

        async function geocodeAddress(address) {
            try {
                const response = await fetch(`https://catalog.api.2gis.com/3.0/items/geocode?q=${encodeURIComponent(address)}&fields=items.point&key=40074715-85b5-400f-a2a8-a41b550be1e8`);
                
                if (!response.ok) {
                    throw new Error(`Ошибка геокодинга: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.result && data.result.items && data.result.items.length > 0) {
                    const point = data.result.items[0].point;
                    return {
                        lon: point.lon,
                        lat: point.lat
                    };
                } else {
                    throw new Error('Адрес не найден');
                }
            } catch (error) {
                console.error('Ошибка геокодинга:', error);
                throw error;
            }
        }

        function calculateRouteDistance(coordinates) {
            let totalDistance = 0;
            for (let i = 1; i < coordinates.length; i++) {
                totalDistance += calculateSimpleDistance(coordinates[i-1], coordinates[i]);
            }
            return (totalDistance).toFixed(1);
        }

        function calculateSimpleDistance(coord1, coord2) {
            const R = 6371; // Радиус Земли в км
            const dLat = (coord2[1] - coord1[1]) * Math.PI / 180;
            const dLon = (coord2[0] - coord1[0]) * Math.PI / 180;
            const a = 
                Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(coord1[1] * Math.PI / 180) * Math.cos(coord2[1] * Math.PI / 180) * 
                Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return (R * c).toFixed(1);
        }

        function showMoscow() {
            if (map) {
                map.setCenter([37.6175, 55.7558]);
                map.setZoom(13);
                updateStatus('Карта центрирована на Москве');
            }
        }

        function getUserLocation() {
            if (!navigator.geolocation) {
                alert('Геолокация не поддерживается вашим браузером');
                return;
            }

            updateStatus('Определение местоположения...');

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const coords = [position.coords.longitude, position.coords.latitude];
                    showUserLocation(coords, position.coords.accuracy);
                    updateStatus('Местоположение определено!');
                },
                (error) => {
                    handleLocationError(error);
                }
            );
        }

        

        function showUserLocation(coords, accuracy) {
            if (!map) return;

            if (userMarker) {
                userMarker.destroy();
            }

            userMarker = new mapgl.Marker(map, {
                coordinates: coords,
                icon: 'https://docs.2gis.com/img/mapgl/marker.svg',
                color: '#28a745',
                size: [45, 45]
            });

            map.setCenter(coords);
            map.setZoom(16);
            updateCoordinates(coords, accuracy);
        }

        function updateCoordinates(coords, accuracy) {
            const coordsElement = document.getElementById('coordinates');
            if (coordsElement) {
                coordsElement.innerHTML = `
                    <strong>Координаты:</strong><br>
                    Широта: ${coords[1].toFixed(6)}<br>
                    Долгота: ${coords[0].toFixed(6)}<br>
                    Точность: ${accuracy ? accuracy.toFixed(0) + ' м' : 'неизвестно'}
                `;
            }
        }

        function handleLocationError(error) {
            let message = '';
            
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    message = 'Доступ к геолокации запрещен';
                    break;
                case error.POSITION_UNAVAILABLE:
                    message = 'Информация о местоположении недоступна';
                    break;
                case error.TIMEOUT:
                    message = 'Время запроса истекло';
                    break;
                default:
                    message = 'Произошла неизвестная ошибка';
                    break;
            }
            
            updateStatus('Ошибка: ' + message);
        }

        function updateStatus(text) {
            const statusElement = document.getElementById('status');
            if (statusElement) {
                statusElement.textContent = text;
            }
        }


        function toggleTaskList() {
            alert('Функция списка задач - чтобы не искать по карте. Будет реализована в будущем..');
        }

        window.addEventListener('load', initMap);

        window.addEventListener('beforeunload', () => {
            stopTracking();
        });
    </script>
</body>
</html>
